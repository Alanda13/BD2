--PRIMEIRA TRIGGER
CREATE OR REPLACE FUNCTION EH_COMBO()
RETURNS TRIGGER AS $$ 
BEGIN 
    IF CAMPO_E = 'S' THEN
	NEW.VALOR := 0
	END IF;
RETURN NEW;
END;
$$ LANGUAGE PLPGSLQ;

CREATE TRIGGER PRIMEIRA_FUNCAO
BEFORE INSERT ON PRODUTO
FOR EACH ROW
EXECUTE FUNCTION EH_COMBO();

--SEGUNDA TRIGGER
CREATE FUNCTION VERIFICAR_COMBO()
RETURNS TRIGGER AS $$
BEGIN
     IF NOT EXISTS (
     SELECT 1 FROM PRODUTO 
     WHERE COD_PRODUTO = NEW.COD_PROD_COMBO AND E_COMBO = 'S') 
	 THEN
          RAISE EXCEPTION 'ERRO! O PRODUTO % NÃO ESTÁ MARCADO COMO COMBO!', NEW.COD_PROD_COMBO;
     END IF;
	 
	 UPDATE PRODUTO
	 SET VALOR = (
	   SELECT ROUND(SUM(P.VALOR)*0.8, 2)
	   FROM COMBO C
	   JOIN PRODUTO ON P.COD_PRODUTO = P.COD_PROD_INCLUSO
	   WHERE C.COD_PROD_COMBO = NEW.COD_PROD_COMBO
	 )
	 WHERE COD_PRODUTO = NEW.COD_PROD_COMBO;
	 RETURN NEW;
	 END;
	 $$ LANGUAGE PLPGSQL;
	 
CREATE TRIGGER SEG_FUNCAO
AFTER INSERT ON COMBO
FOR EACH ROW